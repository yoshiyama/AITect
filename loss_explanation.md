# AITectの損失関数の詳細解説

## 概要
AITectでは、物体検出の学習に複数の損失関数を実装しています。主に以下の2つのアプローチがあります：

1. **標準損失関数** (`loss.py`)
2. **YOLOスタイル損失関数** (`loss_yolo_style.py`)

## 1. 標準損失関数の仕組み

### 損失の2つの要素

物体検出の損失は大きく2つの部分から構成されます：

```
総損失 = 信頼度損失 + 回帰損失
```

### 1.1 信頼度損失（Confidence Loss）
「そこに物体があるか？」を学習する損失

```python
# 各予測に対して、物体の有無（0 or 1）を予測
信頼度損失 = BCE(予測スコア, ターゲット)
```

- **正例（物体あり）**: GTボックスから50ピクセル以内の予測
- **負例（物体なし）**: それ以外の予測

### 1.2 回帰損失（Regression Loss）
「物体の位置とサイズ」を学習する損失

標準実装では3つのモードがあります：

1. **IoU損失のみ** (`loss_type='iou_only'`)
   ```
   損失 = 1 - IoU（予測ボックス, GTボックス）
   ```

2. **L1損失のみ** (`loss_type='l1_only'`)
   ```
   損失 = |予測x - GTx| + |予測y - GTy| + |予測w - GTw| + |予測h - GTh|
   ```

3. **混合損失** (`loss_type='mixed'`) ← デフォルト
   ```
   損失 = IoU損失 × iou_weight + L1損失 × l1_weight
   ```

### 1.3 Focal Loss（オプション）
クラス不均衡問題に対処するための改良版

```python
FL = -α × (1-pt)^γ × log(pt)
```

- **α = 0.25**: 正例の重み
- **γ = 2.0**: 難易度の調整パラメータ
- 簡単なサンプル（高信頼度の負例）の影響を抑制

## 2. YOLOスタイル損失関数の特徴

### 2.1 重み付けの差別化
```python
λ_coord = 5.0    # 座標回帰の重み（大きく）
λ_obj = 1.0      # 物体ありの信頼度損失
λ_noobj = 0.5    # 物体なしの信頼度損失（小さく）
```

### 2.2 責任の割り当て
各GTボックスに対して、必ず1つ以上の予測を「責任あり」として割り当て：

1. **各GTに最もIoUが高い予測を正例に**
2. **IoU > 0.5の予測も追加で正例に**
3. **IoU 0.3-0.5の予測は無視（Ignore）**

### 2.3 座標損失の工夫
```python
# 中心座標：通常のMSE損失
center_loss = MSE(予測中心, GT中心)

# サイズ：平方根でMSE（小さいボックスを重視）
size_loss = MSE(√予測サイズ, √GTサイズ)
```

## 3. 損失計算の具体例

### 例：画像に白線が2本ある場合

```
予測: 192個のボックス（16×16グリッド×3アンカー）
GT: 2個のボックス
```

#### ステップ1：正例・負例の分類
```
- 正例：GTに近い予測（例：5個）
- 負例：GTから遠い予測（例：180個）
- 無視：中途半端な予測（例：7個）
```

#### ステップ2：信頼度損失の計算
```
正例の損失 = BCE(高いスコアを期待) × 1.0 × 5個
負例の損失 = BCE(低いスコアを期待) × 0.5 × 180個
```

#### ステップ3：回帰損失の計算（正例のみ）
```
各正例について：
- IoU損失 = 1 - 0.7 = 0.3（例：IoU=0.7の場合）
- L1損失 = 位置とサイズの差の平均
- 混合損失 = 0.3 × 2.0 + L1損失 × 0.5
```

#### ステップ4：総損失
```
総損失 = 信頼度損失 + 回帰損失 × 5.0（重み）
```

## 4. パラメータの意味と調整指針

| パラメータ | デフォルト値 | 意味 | 調整方法 |
|-----------|------------|------|----------|
| `iou_weight` | 2.0 | IoU損失の重み | 位置精度を上げたい場合は増やす |
| `l1_weight` | 0.5 | L1損失の重み | 細かい位置調整が必要な場合は増やす |
| `λ_coord` | 5.0 | 座標損失全体の重み | 位置精度重視なら増やす |
| `λ_noobj` | 0.5 | 負例の重み | 誤検出が多い場合は増やす |
| `focal_gamma` | 2.0 | 難易度調整 | より難しいサンプルに集中したい場合は増やす |

## 5. 損失の診断方法

### 良い学習の兆候
- 信頼度損失と回帰損失が両方とも減少
- 正例の数が適切（GTの数の2-5倍程度）
- Ignoreされる予測が存在（境界領域の適切な処理）

### 問題の兆候と対策

#### 問題1：すべて負例として学習
```
症状：正例数 = 0
対策：distance_threshold を増やす（50→100）
```

#### 問題2：位置が収束しない
```
症状：回帰損失が下がらない
対策：λ_coord を増やす（5.0→10.0）
```

#### 問題3：誤検出が多い
```
症状：FPが多い
対策：λ_noobj を増やす（0.5→1.0）
```

## まとめ

AITectの損失関数は、物体検出の2つの課題を同時に解決します：
1. **物体の有無を判定**（信頼度損失）
2. **物体の位置を正確に予測**（回帰損失）

YOLOスタイルの実装により、クラス不均衡問題に対処し、より安定した学習を実現しています。